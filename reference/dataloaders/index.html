<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=.9,maximum-scale=.9"><meta name=description content="Speeding up your GraphQL requests by reducing the number of round trips to the database."><title>Optimizing N+1 database queries using Dataloaders &mdash; gqlgen</title><link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,700|Source+Code+Pro:400,700|Work+Sans:500,700" rel=stylesheet><link rel=stylesheet href="https://gqlgen.com/main.css?v=3" type=text/css><link rel=stylesheet href="https://gqlgen.com/syntax.css?v=2" type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116208894-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-116208894-2');</script><script src="https://gqlgen.com/main.js?v=1" async></script></head><body><div class=version-switcher><span></span><div class=version-switcher-options><a class=version-switcher-option></a></div></div><div class=layout--logo><a class=logo href=http://github.com/99designs/gqlgen><svg viewBox="0 0 31.92 31.43" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-79.29 -106.7)"><path transform="matrix(.2646 0 0 .2646 79.29 106.7)" d="m31.95.0c-5.673.0-10.27 4.598-10.27 10.27.0.5862.06001 1.157.1543 1.717l-19.74 11.39c-1.239.5653-2.1 1.816-2.1 3.266v65.51h.01562c.001603 1.235.6446 2.437 1.793 3.096l20.03 11.56c-.09429.5594-.1543 1.131-.1543 1.717.0 5.673 4.598 10.27 10.27 10.27 5.674.0 10.27-4.6 10.27-10.27.0-5.673-4.598-10.27-10.27-10.27-2.492.0-4.774.8879-6.553 2.363l-18.22-10.52v-61.4l18.22-10.52c1.778 1.475 4.061 2.363 6.553 2.363 5.674.0 10.27-4.6 10.27-10.27.0-5.673-4.598-10.27-10.27-10.27zm56.73.0c-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 2.492.0 4.776-.8879 6.555-2.363l18.22 10.52v61.4l-18.22 10.52c-1.778-1.474-4.062-2.361-6.553-2.361-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 5.675.0 10.27-4.6 10.27-10.27.0-.5862-.06002-1.157-.1543-1.717l19.74-11.39c1.239-.5653 2.1-1.814 2.1-3.264v-65.51h-.01562c-.00133-1.236-.6437-2.438-1.793-3.098l-20.03-11.56c.09428-.5594.1543-1.131.1543-1.717.0-5.673-4.597-10.27-10.27-10.27zm-28.37 20.76c-5.675.0-10.27 4.598-10.27 10.27.0 1.524.3402 2.967.9355 4.268l-14.76 14.76c-1.301-.5953-2.742-.9355-4.266-.9355-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 1.524.0 2.963-.3406 4.264-.9355l14.77 14.77c-.5953 1.301-.9355 2.742-.9355 4.266.0 5.673 4.599 10.27 10.27 10.27 5.672.0 10.27-4.596 10.27-10.27.0-1.524-.3401-2.965-.9355-4.266l15.63-15.63c.5748.0998 1.162.1621 1.766.1621 5.675.0 10.27-4.598 10.27-10.27.0-5.675-4.599-10.27-10.27-10.27-1.524.0-2.965.3404-4.266.9355l-13.13-13.13c.5954-1.301.9355-2.743.9355-4.268.0-5.673-4.599-10.27-10.27-10.27zm-4.266 19.61c1.3.5949 2.742.9355 4.266.9355 1.523.0 2.964-.3408 4.264-.9355l13.13 13.13c-.5948 1.3-.9355 2.742-.9355 4.266.0 2.377.8147 4.558 2.17 6.299l-14.36 14.37c-1.3-.5947-2.741-.9336-4.264-.9336-1.524.0-2.965.3388-4.266.9336l-14.77-14.77c.5949-1.3.9355-2.74.9355-4.264.0-1.523-.3389-2.964-.9336-4.264l14.76-14.77z"/></g></svg><span class=logo--name>gqlgen</span></a></div><nav><input class=hamburger-toggle type=checkbox><div class=hamburger><span></span><span></span><span></span></div><ul class=menu><li><a class=menu-item href=https://gqlgen.com/>Introduction</a></li><li><a class=menu-item href=https://gqlgen.com/getting-started/>Getting Started</a></li><li><a class=menu-item href=https://gqlgen.com/config/>Configuration</a></li><li><a class=menu-item href=https://gqlgen.com/feature-comparison/>Feature Comparison</a></li><li><span class="menu-item submenu-heading">Reference</span><ul class=submenu><li><a class=menu-item href=https://gqlgen.com/reference/apq/>APQ</a></li><li><a class=menu-item href=https://gqlgen.com/reference/changesets/>Changesets</a></li><li class=active><a class=menu-item href=https://gqlgen.com/reference/dataloaders/>Dataloaders</a></li><li><a class=menu-item href=https://gqlgen.com/reference/field-collection/>Field Collection</a></li><li><a class=menu-item href=https://gqlgen.com/reference/file-upload/>File Upload</a></li><li><a class=menu-item href=https://gqlgen.com/reference/errors/>Handling Errors</a></li><li><a class=menu-item href=https://gqlgen.com/reference/introspection/>Introspection</a></li><li><a class=menu-item href=https://gqlgen.com/reference/plugins/>Plugins</a></li><li><a class=menu-item href=https://gqlgen.com/reference/complexity/>Query Complexity</a></li><li><a class=menu-item href=https://gqlgen.com/reference/resolvers/>Resolvers</a></li><li><a class=menu-item href=https://gqlgen.com/reference/scalars/>Scalars</a></li><li><a class=menu-item href=https://gqlgen.com/reference/directives/>Schema Directives</a></li><li><a class=menu-item href=https://godoc.org/github.com/99designs/gqlgen>godoc
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941.0l-22.627-22.627c-9.373-9.373-9.373-24.569.0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656.0 424.024.0H552c13.255.0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999.0 00384 303.765V448H64V128h264a24.003 24.003.0 0016.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"/></svg></span></a></li></ul></li><li><span class="menu-item submenu-heading">Recipes</span><ul class=submenu><li><a class=menu-item href=https://gqlgen.com/recipes/federation/>Apollo Federation</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/authentication/>Authentication</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/cors/>CORS</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/ent/>Ent</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/gin/>Gin</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/migration-0.11/>Migrating to 0.11</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/modelgen-hook/>Modelgen hook</a></li></ul></li></ul></nav><header><div class=content><h1>Dataloaders</h1><div class=description>Optimizing N+1 database queries using Dataloaders</div><a class=header-link target=_blank href=https://github.com/99designs/gqlgen/blob/master/docs/content/reference/dataloaders.md>[edit]</a></div></header><main><div class=content><p>Have you noticed some GraphQL queries end can make hundreds of database
queries, often with mostly repeated data? Lets take a look why and how to
fix it.</p><h2 id=query-resolution>Query Resolution</h2><p>Imagine if you had a simple query like this:</p><div class=highlight><pre class=chroma><code class=language-graphql data-lang=graphql><span class=kd>query</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nc>todos</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=py>users</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=py>name</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>}</span><span class=w> </span><span class=p>}</span><span class=w>
</span></code></pre></div><p>and our todo.user resolver looks like this:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>todoResolver</span><span class=p>)</span> <span class=nf>UserRaw</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>obj</span> <span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>Todo</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>res</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>LogAndQuery</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=s>&#34;SELECT id, name FROM dataloader_example.user WHERE id = ?&#34;</span><span class=p>,</span> <span class=nx>obj</span><span class=p>.</span><span class=nx>UserID</span><span class=p>)</span>
	<span class=k>defer</span> <span class=nx>res</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

	<span class=k>if</span> <span class=p>!</span><span class=nx>res</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
	<span class=p>}</span>
	<span class=kd>var</span> <span class=nx>user</span> <span class=nx>model</span><span class=p>.</span><span class=nx>User</span>
	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>res</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>,</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div><p><strong>Note</strong>: I&rsquo;m going to use go&rsquo;s low level <code>sql.DB</code> here. All of this will
work with whatever your favourite ORM is.</p><p>The query executor will call the Query.Todos resolver which does a <code>select * from todo</code> and
return N todos. Then for each of the todos, concurrently, call the Todo_user resolver,
<code>SELECT from USER where id = todo.user_id</code>.</p><p>eg:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>todo</span><span class=p>,</span> <span class=n>user_id</span> <span class=k>FROM</span> <span class=n>todo</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>FROM</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=o>=</span> <span class=o>?</span>
</code></pre></div><p>Whats even worse? most of those todos are all owned by the same user! We can do better than this.</p><h2 id=dataloader>Dataloader</h2><p>What we need is a way to group up all of those concurrent requests, take out any duplicates, and
store them in case they are needed later on in request. The dataloader is just that, a request-scoped
batching and caching solution popularised by <a href=https://github.com/facebook/dataloader>facebook</a>.</p><p>We&rsquo;re going to use <a href=https://github.com/vektah/dataloaden>dataloaden</a> to build our dataloaders.
In languages with generics, we could probably just create a DataLoader, but golang
doesnt have generics. Instead we generate the code manually for our instance.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>go get github.com/vektah/dataloaden
mkdir dataloader
<span class=nb>cd</span> dataloader
go run github.com/vektah/dataloaden UserLoader int *gqlgen-tutorials/dataloader/graph/model.User
</code></pre></div><p>Next we need to create an instance of our new dataloader and tell how to fetch data.
Because dataloaders are request scoped, they are a good fit for <code>context</code>.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go>
<span class=kd>const</span> <span class=nx>loadersKey</span> <span class=p>=</span> <span class=s>&#34;dataloaders&#34;</span>

<span class=kd>type</span> <span class=nx>Loaders</span> <span class=kd>struct</span> <span class=p>{</span>
	<span class=nx>UserById</span> <span class=nx>UserLoader</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>Middleware</span><span class=p>(</span><span class=nx>conn</span> <span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>DB</span><span class=p>,</span> <span class=nx>next</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span><span class=p>)</span> <span class=nx>http</span><span class=p>.</span><span class=nx>Handler</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>http</span><span class=p>.</span><span class=nf>HandlerFunc</span><span class=p>(</span><span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>ctx</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithValue</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nf>Context</span><span class=p>(),</span> <span class=nx>loadersKey</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>Loaders</span><span class=p>{</span>
			<span class=nx>UserById</span><span class=p>:</span> <span class=nx>UserLoader</span><span class=p>{</span>
				<span class=nx>maxBatch</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
				<span class=nx>wait</span><span class=p>:</span>     <span class=mi>1</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>,</span>
				<span class=nx>fetch</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ids</span> <span class=p>[]</span><span class=kt>int</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>,</span> <span class=p>[]</span><span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
					<span class=nx>placeholders</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ids</span><span class=p>))</span>
					<span class=nx>args</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ids</span><span class=p>))</span>
					<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ids</span><span class=p>);</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
						<span class=nx>placeholders</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=s>&#34;?&#34;</span>
						<span class=nx>args</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>i</span>
					<span class=p>}</span>

					<span class=nx>res</span> <span class=o>:=</span> <span class=nx>db</span><span class=p>.</span><span class=nf>LogAndQuery</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span>
						<span class=s>&#34;SELECT id, name from dataloader_example.user WHERE id IN (&#34;</span><span class=o>+</span><span class=nx>strings</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>placeholders</span><span class=p>,</span> <span class=s>&#34;,&#34;</span><span class=p>)</span><span class=o>+</span><span class=s>&#34;)&#34;</span><span class=p>,</span>
						<span class=nx>args</span><span class=o>...</span><span class=p>,</span>
					<span class=p>)</span>
					<span class=k>defer</span> <span class=nx>res</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>

					<span class=nx>userById</span> <span class=o>:=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>{}</span>
					<span class=k>for</span> <span class=nx>res</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
						<span class=nx>user</span> <span class=o>:=</span> <span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>{}</span>
						<span class=nx>err</span> <span class=o>:=</span> <span class=nx>res</span><span class=p>.</span><span class=nf>Scan</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>ID</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>user</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
						<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
							<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
						<span class=p>}</span>
						<span class=nx>userById</span><span class=p>[</span><span class=nx>user</span><span class=p>.</span><span class=nx>ID</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>user</span>
					<span class=p>}</span>

					<span class=nx>users</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ids</span><span class=p>))</span>
					<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>id</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>ids</span> <span class=p>{</span>
						<span class=nx>users</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>userById</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span>
					<span class=p>}</span>

					<span class=k>return</span> <span class=nx>users</span><span class=p>,</span> <span class=kc>nil</span>
				<span class=p>},</span>
			<span class=p>},</span>
		<span class=p>})</span>
		<span class=nx>r</span> <span class=p>=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>WithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
		<span class=nx>next</span><span class=p>.</span><span class=nf>ServeHTTP</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
	<span class=p>})</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nf>For</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=o>*</span><span class=nx>Loaders</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Value</span><span class=p>(</span><span class=nx>loadersKey</span><span class=p>).(</span><span class=o>*</span><span class=nx>Loaders</span><span class=p>)</span>
<span class=p>}</span>

</code></pre></div><p>This dataloader will wait for up to 1 millisecond to get 100 unique requests and then call
the fetch function. This function is a little ugly, but half of it is just building the SQL!</p><p>Now lets update our resolver to call the dataloader:</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>todoResolver</span><span class=p>)</span> <span class=nf>UserLoader</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>obj</span> <span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>Todo</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>User</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
	<span class=k>return</span> <span class=nx>dataloader</span><span class=p>.</span><span class=nf>For</span><span class=p>(</span><span class=nx>ctx</span><span class=p>).</span><span class=nx>UserById</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>obj</span><span class=p>.</span><span class=nx>UserID</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>The end result? just 2 queries!</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>todo</span><span class=p>,</span> <span class=n>user_id</span> <span class=k>FROM</span> <span class=n>todo</span>
<span class=k>SELECT</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span> <span class=k>from</span> <span class=k>user</span> <span class=k>WHERE</span> <span class=n>id</span> <span class=k>IN</span> <span class=p>(</span><span class=o>?</span><span class=p>,</span><span class=o>?</span><span class=p>,</span><span class=o>?</span><span class=p>,</span><span class=o>?</span><span class=p>,</span><span class=o>?</span><span class=p>)</span>
</code></pre></div><p>The generated UserLoader has a few other useful methods on it:</p><ul><li><code>LoadAll(keys)</code>: If you know up front you want a bunch users</li><li><code>Prime(key, user)</code>: Used to sync state between similar loaders (usersById, usersByNote)</li></ul><p>You can see the full working example <a href=https://github.com/vektah/gqlgen-tutorials/tree/master/dataloader>here</a>.</p></div></main></body></html>