<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=.9,maximum-scale=.9"><meta name=description content="Avoid denial of service attacks by calculating query costs and limiting complexity."><title>Preventing overly complex queries &mdash; gqlgen</title><link href="https://fonts.googleapis.com/css?family=Roboto:400,400i,700|Source+Code+Pro:400,700|Work+Sans:500,700" rel=stylesheet><link rel=stylesheet href="https://gqlgen.com/main.css?v=3" type=text/css><link rel=stylesheet href="https://gqlgen.com/syntax.css?v=2" type=text/css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116208894-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-116208894-2');</script><script src="https://gqlgen.com/main.js?v=1" async></script></head><body><div class=version-switcher><span></span><div class=version-switcher-options><a class=version-switcher-option></a></div></div><div class=layout--logo><a class=logo href=http://github.com/99designs/gqlgen><svg viewBox="0 0 31.92 31.43" xmlns="http://www.w3.org/2000/svg"><g transform="translate(-79.29 -106.7)"><path transform="matrix(.2646 0 0 .2646 79.29 106.7)" d="m31.95.0c-5.673.0-10.27 4.598-10.27 10.27.0.5862.06001 1.157.1543 1.717l-19.74 11.39c-1.239.5653-2.1 1.816-2.1 3.266v65.51h.01562c.001603 1.235.6446 2.437 1.793 3.096l20.03 11.56c-.09429.5594-.1543 1.131-.1543 1.717.0 5.673 4.598 10.27 10.27 10.27 5.674.0 10.27-4.6 10.27-10.27.0-5.673-4.598-10.27-10.27-10.27-2.492.0-4.774.8879-6.553 2.363l-18.22-10.52v-61.4l18.22-10.52c1.778 1.475 4.061 2.363 6.553 2.363 5.674.0 10.27-4.6 10.27-10.27.0-5.673-4.598-10.27-10.27-10.27zm56.73.0c-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 2.492.0 4.776-.8879 6.555-2.363l18.22 10.52v61.4l-18.22 10.52c-1.778-1.474-4.062-2.361-6.553-2.361-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 5.675.0 10.27-4.6 10.27-10.27.0-.5862-.06002-1.157-.1543-1.717l19.74-11.39c1.239-.5653 2.1-1.814 2.1-3.264v-65.51h-.01562c-.00133-1.236-.6437-2.438-1.793-3.098l-20.03-11.56c.09428-.5594.1543-1.131.1543-1.717.0-5.673-4.597-10.27-10.27-10.27zm-28.37 20.76c-5.675.0-10.27 4.598-10.27 10.27.0 1.524.3402 2.967.9355 4.268l-14.76 14.76c-1.301-.5953-2.742-.9355-4.266-.9355-5.673.0-10.27 4.598-10.27 10.27.0 5.673 4.598 10.27 10.27 10.27 1.524.0 2.963-.3406 4.264-.9355l14.77 14.77c-.5953 1.301-.9355 2.742-.9355 4.266.0 5.673 4.599 10.27 10.27 10.27 5.672.0 10.27-4.596 10.27-10.27.0-1.524-.3401-2.965-.9355-4.266l15.63-15.63c.5748.0998 1.162.1621 1.766.1621 5.675.0 10.27-4.598 10.27-10.27.0-5.675-4.599-10.27-10.27-10.27-1.524.0-2.965.3404-4.266.9355l-13.13-13.13c.5954-1.301.9355-2.743.9355-4.268.0-5.673-4.599-10.27-10.27-10.27zm-4.266 19.61c1.3.5949 2.742.9355 4.266.9355 1.523.0 2.964-.3408 4.264-.9355l13.13 13.13c-.5948 1.3-.9355 2.742-.9355 4.266.0 2.377.8147 4.558 2.17 6.299l-14.36 14.37c-1.3-.5947-2.741-.9336-4.264-.9336-1.524.0-2.965.3388-4.266.9336l-14.77-14.77c.5949-1.3.9355-2.74.9355-4.264.0-1.523-.3389-2.964-.9336-4.264l14.76-14.77z"/></g></svg><span class=logo--name>gqlgen</span></a></div><nav><input class=hamburger-toggle type=checkbox><div class=hamburger><span></span><span></span><span></span></div><ul class=menu><li><a class=menu-item href=https://gqlgen.com/>Introduction</a></li><li><a class=menu-item href=https://gqlgen.com/getting-started/>Getting Started</a></li><li><a class=menu-item href=https://gqlgen.com/config/>Configuration</a></li><li><a class=menu-item href=https://gqlgen.com/feature-comparison/>Feature Comparison</a></li><li><span class="menu-item submenu-heading">Reference</span><ul class=submenu><li><a class=menu-item href=https://gqlgen.com/reference/apq/>APQ</a></li><li><a class=menu-item href=https://gqlgen.com/reference/changesets/>Changesets</a></li><li><a class=menu-item href=https://gqlgen.com/reference/dataloaders/>Dataloaders</a></li><li><a class=menu-item href=https://gqlgen.com/reference/field-collection/>Field Collection</a></li><li><a class=menu-item href=https://gqlgen.com/reference/file-upload/>File Upload</a></li><li><a class=menu-item href=https://gqlgen.com/reference/errors/>Handling Errors</a></li><li><a class=menu-item href=https://gqlgen.com/reference/introspection/>Introspection</a></li><li><a class=menu-item href=https://gqlgen.com/reference/plugins/>Plugins</a></li><li class=active><a class=menu-item href=https://gqlgen.com/reference/complexity/>Query Complexity</a></li><li><a class=menu-item href=https://gqlgen.com/reference/resolvers/>Resolvers</a></li><li><a class=menu-item href=https://gqlgen.com/reference/scalars/>Scalars</a></li><li><a class=menu-item href=https://gqlgen.com/reference/directives/>Schema Directives</a></li><li><a class=menu-item href=https://godoc.org/github.com/99designs/gqlgen>godoc
<span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M576 24v127.984c0 21.461-25.96 31.98-40.971 16.971l-35.707-35.709-243.523 243.523c-9.373 9.373-24.568 9.373-33.941.0l-22.627-22.627c-9.373-9.373-9.373-24.569.0-33.941L442.756 76.676l-35.703-35.705C391.982 25.9 402.656.0 424.024.0H552c13.255.0 24 10.745 24 24zM407.029 270.794l-16 16A23.999 23.999.0 00384 303.765V448H64V128h264a24.003 24.003.0 0016.97-7.029l16-16C376.089 89.851 365.381 64 344 64H48C21.49 64 0 85.49.0 112v352c0 26.51 21.49 48 48 48h352c26.51.0 48-21.49 48-48V287.764c0-21.382-25.852-32.09-40.971-16.97z"/></svg></span></a></li></ul></li><li><span class="menu-item submenu-heading">Recipes</span><ul class=submenu><li><a class=menu-item href=https://gqlgen.com/recipes/federation/>Apollo Federation</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/authentication/>Authentication</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/cors/>CORS</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/ent/>Ent</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/gin/>Gin</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/migration-0.11/>Migrating to 0.11</a></li><li><a class=menu-item href=https://gqlgen.com/recipes/modelgen-hook/>Modelgen hook</a></li></ul></li></ul></nav><header><div class=content><h1>Query Complexity</h1><div class=description>Preventing overly complex queries</div><a class=header-link target=_blank href=https://github.com/99designs/gqlgen/blob/master/docs/content/reference/complexity.md>[edit]</a></div></header><main><div class=content><p>GraphQL provides a powerful way to query your data, but putting great power in the hands of your API clients also exposes you to a risk of denial of service attacks. You can mitigate that risk with gqlgen by limiting the complexity of the queries you allow.</p><h2 id=expensive-queries>Expensive Queries</h2><p>Consider a schema that allows listing blog posts. Each blog post is also related to other posts.</p><div class=highlight><pre class=chroma><code class=language-graphql data-lang=graphql><span class=kd>type</span><span class=w> </span><span class=nc>Query</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=py>posts</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>Int</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=py>10</span><span class=p>):</span><span class=w> </span><span class=p>[</span><span class=nc>Post</span><span class=p>!]!</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nc>Post</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=py>title</span><span class=p>:</span><span class=w> </span><span class=nc>String</span><span class=p>!</span><span class=w>
</span><span class=w>	</span><span class=py>text</span><span class=p>:</span><span class=w> </span><span class=nc>String</span><span class=p>!</span><span class=w>
</span><span class=w>	</span><span class=py>related</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>Int</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=py>10</span><span class=p>):</span><span class=w> </span><span class=p>[</span><span class=nc>Post</span><span class=p>!]!</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>It&rsquo;s not too hard to craft a query that will cause a very large response:</p><div class=highlight><pre class=chroma><code class=language-graphql data-lang=graphql><span class=p>{</span><span class=w>
</span><span class=w>	</span><span class=py>posts</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>		</span><span class=py>related</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>			</span><span class=py>related</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>				</span><span class=py>related</span><span class=p>(</span><span class=py>count</span><span class=p>:</span><span class=w> </span><span class=nc>100</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span><span class=w>					</span><span class=py>title</span><span class=w>
</span><span class=w>				</span><span class=p>}</span><span class=w>
</span><span class=w>			</span><span class=p>}</span><span class=w>
</span><span class=w>		</span><span class=p>}</span><span class=w>
</span><span class=w>	</span><span class=p>}</span><span class=w>
</span><span class=w></span><span class=p>}</span><span class=w>
</span></code></pre></div><p>The size of the response grows exponentially with each additional level of the <code>related</code> field. Fortunately, gqlgen&rsquo;s <code>http.Handler</code> includes a way to guard against this type of query.</p><h2 id=limiting-query-complexity>Limiting Query Complexity</h2><p>Limiting query complexity is as simple as specifying it with the provided extension package.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>Config</span><span class=p>{</span> <span class=nx>Resolvers</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>resolvers</span><span class=p>{}</span> <span class=p>}</span>


		<span class=nx>srv</span> <span class=o>:=</span> <span class=nx>handler</span><span class=p>.</span><span class=nf>NewDefaultServer</span><span class=p>(</span><span class=nx>blog</span><span class=p>.</span><span class=nf>NewExecutableSchema</span><span class=p>(</span><span class=nx>c</span><span class=p>))</span>
		<span class=nx>srv</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>extension</span><span class=p>.</span><span class=nf>FixedComplexityLimit</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span> <span class=c1>// This line is key
</span><span class=c1></span>    <span class=nx>r</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/query&#34;</span><span class=p>,</span> <span class=nx>srv</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>Now any query with complexity greater than 5 is rejected by the API. By default, each field and level of depth adds one to the overall query complexity. You can also use <code>extension.ComplexityLimit</code> to dynamically configure the complexity limit per request.</p><p>This helps, but we still have a problem: the <code>posts</code> and <code>related</code> fields, which return arrays, are much more expensive to resolve than the scalar <code>title</code> and <code>text</code> fields. However, the default complexity calculation weights them equally. It would make more sense to apply a higher cost to the array fields.</p><h2 id=custom-complexity-calculation>Custom Complexity Calculation</h2><p>To apply higher costs to certain fields, we can use custom complexity functions.</p><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>c</span> <span class=o>:=</span> <span class=nx>Config</span><span class=p>{</span> <span class=nx>Resolvers</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>resolvers</span><span class=p>{}</span> <span class=p>}</span>

    <span class=nx>countComplexity</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>childComplexity</span><span class=p>,</span> <span class=nx>count</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>int</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>count</span> <span class=o>*</span> <span class=nx>childComplexity</span>
    <span class=p>}</span>
    <span class=nx>c</span><span class=p>.</span><span class=nx>Complexity</span><span class=p>.</span><span class=nx>Query</span><span class=p>.</span><span class=nx>Posts</span> <span class=p>=</span> <span class=nx>countComplexity</span>
    <span class=nx>c</span><span class=p>.</span><span class=nx>Complexity</span><span class=p>.</span><span class=nx>Post</span><span class=p>.</span><span class=nx>Related</span> <span class=p>=</span> <span class=nx>countComplexity</span>

    <span class=nx>srv</span> <span class=o>:=</span> <span class=nx>handler</span><span class=p>.</span><span class=nf>NewDefaultServer</span><span class=p>(</span><span class=nx>blog</span><span class=p>.</span><span class=nf>NewExecutableSchema</span><span class=p>(</span><span class=nx>c</span><span class=p>))</span>
		<span class=nx>srv</span><span class=p>.</span><span class=nf>Use</span><span class=p>(</span><span class=nx>extension</span><span class=p>.</span><span class=nf>FixedComplexityLimit</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
    <span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/query&#34;</span><span class=p>,</span> <span class=nx>gqlHandler</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div><p>When we assign a function to the appropriate <code>Complexity</code> field, that function is used in the complexity calculation. Here, the <code>posts</code> and <code>related</code> fields are weighted according to the value of their <code>count</code> parameter. This means that the more posts a client requests, the higher the query complexity. And just like the size of the response would increase exponentially in our original query, the complexity would also increase exponentially, so any client trying to abuse the API would run into the limit very quickly.</p><p>By applying a query complexity limit and specifying custom complexity functions in the right places, you can easily prevent clients from using a disproportionate amount of resources and disrupting your service.</p></div></main></body></html>